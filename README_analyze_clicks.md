# analyze_clicks.py — User & Technical Documentation

This document explains how to use `tools/analyze_clicks.py` and what it produces.

The goal of this script is to:
- detect FSS “ticks” (click-like transients) in ingested FLAC recordings,
- identify occurrences of a known **7-tick temporal motif**,
- compute a **local intensity metric** for motif ticks (tick energy vs local background),
- export everything in an **audit-friendly** way (timestamps, windows, intermediate values),
  so humans can verify detections in external tools (Audacity, Sonic Visualiser, etc.).

No plots/graphs are generated by this script.

## Repository context

This script is designed to work with the repo structure and naming conventions produced by `tools/ingest.py`.

Typical structure:

- `incoming/`  
  Temporary drop folder (one FLAC at a time) used by `tools/ingest.py`.

- `audio/`  
  Final, ingested recordings. File names are:
  ```
  <SystemNameSafe>__<hash>.flac
  ```

- `metadata/`  
  Per-recording metadata JSON produced by `tools/ingest.py`. File names are:
  ```
  <SystemNameSafe>__<hash>.json
  ```
  Each metadata file contains the corresponding FLAC name in:
  ```
  recording.audio_file
  ```

- `tools/`  
  Python scripts.

## What analyze_clicks.py does

For each `metadata/*.json` file:

1. Resolves the audio file from `recording.audio_file` and loads it from `audio/`.
2. Detects all ticks in the audio (transient detection).
3. Finds all occurrences of a **7-tick motif** by matching a template of 6 inter-tick intervals (Δt).
4. For each tick inside each motif occurrence:
   - computes tick energy in a short time window (default: 20 ms),
   - computes background energy in very local windows (default: 2×10 ms),
     positioned in the **midpoints between neighboring ticks** (“gap midpoints”),
   - computes an intensity ratio in dB:
     ```
     SNR_dB = 10 * log10( E_tick / E_bg )
     ```
5. Writes per-file reports and simple label files for manual verification.

## Installation

Dependencies:

- Python 3.9+ recommended
- `numpy`
- `soundfile`

Install:

```
pip install numpy soundfile
```

Note: `soundfile` may require system audio libraries depending on your OS.

## How to run

From the repo root:

```
python tools/analyze_clicks.py
```

By default it reads:
- `metadata/`
- `audio/`

And writes to:
- `analysis/`

### Useful options

Change motif tolerance (seconds):

```
python tools/analyze_clicks.py --tol 0.04
```

Adjust tick detection thresholds:

```
python tools/analyze_clicks.py --mad-k 10 --min-dist-ms 18
```

Adjust intensity windows:

```
python tools/analyze_clicks.py --tick-win-ms 20 --bg-win-ms 10 --bg-margin-ms 1
```

## Output files

### Global summary
`analysis/summary.json`

Contains:
- parameters used for the run
- list of analyzed systems/files
- intensity summary per system
- error list if any

Per system fields include:
- `system_name`
- `star_pos`
- `ticks_count`
- `motifs_count`
- `Ii_db_median`, `Ii_db_p10`, `Ii_db_p90`

### Per-file detailed report
`analysis/per_file/<SystemNameSafe>__<hash>.json`

Includes:
- recording info (hash, duration, sample rate)
- tick timestamps and sample indices
- motif occurrences and Δt values
- per-tick energy and SNR measurements
- exact analysis windows used

This file is intended for full human audit.

### Label files
For manual verification in external tools:

- `analysis/labels/<System>__<hash>__ticks.txt`
- `analysis/labels/<System>__<hash>__motifs.txt`

Each line is:
```
<time_seconds>    <label>
```

## Algorithms (summary)

### Tick detection
Ticks are detected using:
- discrete derivative (high-pass effect),
- envelope extraction + short smoothing,
- robust MAD-based threshold,
- minimum inter-tick distance enforcement.

### Motif matching
A motif is defined by a fixed template of 6 Δt values.
A sequence of 7 ticks matches if all Δt fall within the tolerance.

Default template:
```
[0.642, 0.643, 0.514, 0.121, 0.646, 0.634] seconds
```

### Intensity measurement
For each motif tick:
- tick energy is measured over 20 ms,
- background energy is measured over 10 ms windows placed at gap midpoints,
- intensity is expressed as:
```
SNR_dB = 10 * log10(E_tick / E_bg)
```

This method remains valid even for closely spaced (“double”) ticks.

## Notes

This script is intentionally conservative and transparent.
It does not attempt to interpret or decode the motif.
It produces a clean, reproducible dataset suitable for:
- cross-system comparison,
- intensity statistics,
- later spatial or physical hypotheses.
